{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Answer Detail - {{ question.title }}{% endblock %}

{% block content %}
<div class="container-fluid py-5">
  <div class="row justify-content-center">
    <div class="col-12 col-md-10 col-lg-9">
      
      <div class="card shadow border-0 rounded-3 p-4 mb-4 position-relative">
        <div class="card-body">

          <h2 class="fw-bold mb-3" style="color: #c75a00ff;">{{ question.title }}</h2>

          <hr class="my-4">

          <div>
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div>
                Answered by <strong>{{ answer.author.username }}</strong>
              </div>
              <div class="text-muted small">
                {{ answer.created_at|naturaltime }}
              </div>
            </div>

            <p class="mb-3">{{ answer.content }}</p>


            <div class="d-flex align-items-center gap-3 mt-3">
              <button id="upvote-btn" class="btn btn-outline-success btn-sm {% if request.user.is_authenticated and answer_user_vote == 1 %}voted-up{% endif %}" data-type="1" data-id="{{ answer.id }}" data-model="answer">
                <i class="bi bi-hand-thumbs-up"></i> (<span id="answer-upvote-count">{{ answer_upvotes }}</span>)
              </button>

              <button id="downvote-btn" class="btn btn-outline-danger btn-sm {% if request.user.is_authenticated and answer_user_vote == -1 %}voted-down{% endif %}" data-type="-1" data-id="{{ answer.id }}" data-model="answer">
                <i class="bi bi-hand-thumbs-down"></i> (<span id="answer-downvote-count">{{ answer_downvotes }}</span>)
              </button>
            </div>

            {% if request.user.is_authenticated and request.user == answer.author %}
            <div class="d-flex justify-content-end gap-3 mt-3">
              <a href="{% url 'answer_update' answer_id=answer.pk %}" class="text-primary fs-5" title="Edit Answer">
                <i class="bi bi-pencil-square"></i>
              </a>
              <a href="{% url 'answer_delete' answer_id=answer.pk %}" class="text-danger fs-5" title="Delete Answer">
                <i class="bi bi-trash"></i>
              </a>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      <a href="{% url 'question_detail' question.pk %}" 
         class="btn btn-outline-secondary mb-4 px-4 py-2">
        ← Back to Question
      </a>      

      <!-- ✅ Comments Section -->
      <hr class="my-4">
      <h4 class="mt-4 mb-3">Comments ({{ comments.paginator.count }})</h4>

      <!-- ✅ Inline Comment Box -->
      <div class="card shadow-sm border-0 rounded-3 mb-4">
        <div class="card-body">
          <form id="comment-form" method="post" action="">
            {% csrf_token %}
            <div>
              <textarea
                name="content"
                id="id_content"
                class="form-control mb-3"
                rows="4"
                placeholder="Add a public comment..."
                required
                style="resize: vertical;"
              ></textarea>
              <div class="d-flex justify-content-end gap-2">
                <button type="reset" class="btn btn-outline-danger btn-sm">Clear</button>
                <button type="submit" class="btn btn-primary btn-sm">Comment</button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- ✅ Render Comments -->
      {% for comment in comments %}
        {% include "forum/_comment_card.html" with comment=comment %}
      {% empty %}
        <p class="text-muted fst-italic">No comments yet.</p>
      {% endfor %}

      {% include "_pagination.html" %}
      <!-- ✅ End Comments Section -->

    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {

  const commentForm = document.getElementById("comment-form");
  if (commentForm) {
    commentForm.addEventListener("submit", function (e) {
      {% if not user.is_authenticated %}
        e.preventDefault();

        if (!document.querySelector(".login-warning-alert")) {
          const alertDiv = document.createElement("div");
          alertDiv.className = "alert alert-warning alert-dismissible fade show login-warning-alert mt-3";
          alertDiv.role = "alert";
          alertDiv.innerHTML = `
            <strong>⚠️ Please login</strong> to add a comment.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          `;
          commentForm.parentElement.prepend(alertDiv);
        }
        return;
      {% endif %}
    });
  }

  // ✅ Handle showing/hiding replies
  document.addEventListener("click", function(e) {
  if (e.target.classList.contains("toggle-replies")) {
    const repliesDiv = e.target.closest(".card-body").querySelector(".replies");
    if (repliesDiv) {
      repliesDiv.classList.toggle("d-none");
      const replyCount = e.target.dataset.replyCount;
      e.target.textContent = repliesDiv.classList.contains("d-none")
        ? `View Replies (${replyCount})`
        : "Hide Replies";
    }
  }
});
document.addEventListener("click", function (e) {
  // --- Show reply form ---
  if (e.target.classList.contains("reply-btn")) {
    const commentCard = e.target.closest(".card-body");
    const formContainer = commentCard.querySelector(".reply-form-container");
    if (formContainer) {
      formContainer.classList.remove("d-none");
      e.target.classList.add("d-none");
    }
  }

  // --- Cancel reply ---
  if (e.target.classList.contains("cancel-reply")) {
    const formContainer = e.target.closest(".reply-form-container");
    formContainer.classList.add("d-none");

    const commentCard = formContainer.closest(".card-body");
    const replyBtn = commentCard.querySelector(".reply-btn");
    if (replyBtn) replyBtn.classList.remove("d-none");
  }
});

document.addEventListener("submit", async function (e) {
  if (e.target.classList.contains("reply-form")) {
    e.preventDefault();

    const form = e.target;
    const parentId = form.dataset.parentId;
    const content = form.querySelector("textarea").value.trim();
    const csrfToken = form.querySelector("[name=csrfmiddlewaretoken]").value;

    if (!content) return;

    try {
      const response = await fetch("", {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken,
          "Content-Type": "application/x-www-form-urlencoded",
        },
        body: new URLSearchParams({
          content: content,
          parent: parentId,
        }),
      });

      if (response.redirected) {
        window.location.href = response.url;
      } else if (response.ok) {
        window.location.reload();
      } else {
        console.error("Failed to post reply:", response.statusText);
      }
    } catch (error) {
      console.error("Error submitting reply:", error);
    }
  }
});
});
</script>

{% endblock %}
