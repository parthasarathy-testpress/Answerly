{% load widget_tweaks vote_tags %}
<section 
  class="d-flex align-items-center justify-content-center mb-5 text-center text-white"
  style="
    background: linear-gradient(rgba(59, 77, 94, 0.85), rgba(51, 125, 204, 0.85)),
    url('https://about.fb.com/wp-content/uploads/2022/11/Community-Forums-Phase-2_Header.jpg?w=1920') top/cover no-repeat;
    min-height: 300px;
    padding: 60px 0;
  "
>
  <div class="container">
    <h2 class="fw-bold mb-4 fs-2">How Can We Help?</h2>

    <form method="get" class="row justify-content-center align-items-center g-2">

      <div class="col-md-5 col-sm-12">
        {{ filter.form.question|add_class:"form-control rounded-pill px-4 py-3"|attr:"placeholder:Enter a keyword..." }}
      </div>

      <div class="col-md-3 col-sm-8" x-data="tagMultiSelect()" x-init="initTags()">
        <div class="position-relative">
          <div 
            class="form-control rounded-pill px-4 py-3 d-flex flex-wrap align-items-center gap-2" 
            style="min-height: 48px; cursor: pointer;"
            @click="toggleDropdown()"
            @click.away="isOpen = false"
          >
            <template x-if="selectedTags.length === 0">
              <span class="text-muted small">Select Tags...</span>
            </template>
            <template x-for="tag in selectedTags" :key="tag.id">
              <span class="badge bg-secondary d-flex align-items-center gap-1" style="font-size: 0.75rem;">
                <span x-text="tag.name"></span>
                <i class="bi bi-x-circle" @click.stop="toggleTag(tag)" style="cursor: pointer; font-size: 0.7rem;"></i>
              </span>
            </template>
            <i class="bi bi-chevron-down ms-auto" :class="{'bi-chevron-up': isOpen}"></i>
          </div>
          
          <div 
            x-show="isOpen"
            x-transition
            class="position-absolute w-100 bg-white border rounded mt-1 shadow-lg"
            style="border-radius: 0.5rem !important; max-height: 250px; overflow-y: auto; z-index: 1000; top: 100%;"
          >
            <div class="p-2 border-bottom">
              <input 
                type="text" 
                class="form-control form-control-sm" 
                placeholder="Search tags..."
                x-model="searchQuery"
                @click.stop
              >
            </div>
            <div class="p-1">
              <template x-for="tag in filteredTags" :key="tag.id">
                <div 
                  class="px-3 py-2 d-flex align-items-center tag-option"
                  style="cursor: pointer;"
                  @click.stop="toggleTag(tag)"
                  :class="{'bg-primary text-white': isSelected(tag), 'text-dark': !isSelected(tag)}"
                >
                  <span class="small" x-text="tag.name"></span>
                  <i class="bi bi-check-circle ms-auto" x-show="isSelected(tag)"></i>
                </div>
              </template>
              <template x-if="filteredTags.length === 0">
                <div class="px-3 py-2 text-muted small text-center">No tags found</div>
              </template>
            </div>
          </div>
          
          <!-- Hidden inputs for form submission -->
          <template x-for="tag in selectedTags" :key="tag.id">
            <input type="hidden" name="{{ filter.form.tag.name }}" :value="tag.id">
          </template>
        </div>
      </div>

      <div class="col-md-2 col-sm-6">
        {{ filter.form.vote_type|add_class:"form-select rounded-pill px-4 py-3" }}
      </div>

      <div class="col-md-1 col-sm-3 d-grid">
        <button 
          type="submit" 
          class="btn btn-light rounded-pill d-flex align-items-center justify-content-center fw-semibold"
        >
          <i class="bi bi-search"></i>
        </button>
      </div>

      <div class="col-md-1 col-sm-3 d-grid">
        <a 
          href="{% url 'question_list' %}" 
          class="btn btn-outline-light  rounded-pill fw-semibold d-flex align-items-center justify-content-center"
        >
          Clear
        </a>
      </div>
    </form>
  </div>
</section>

<script>
  // Store tags data globally so Alpine can access it
  window.tagsData = {{ filter.form.tag.field.queryset|tags_to_json|safe }};
  {% get_selected_tag_ids request as selected_tag_ids_json %}
  window.selectedTagIds = {{ selected_tag_ids_json|safe }};
</script>

<script>
  document.addEventListener('alpine:init', () => {
    Alpine.data('tagMultiSelect', () => ({
      isOpen: false,
      searchQuery: '',
      allTags: [],
      selectedTags: [],
      
      initTags() {
        // Initialize tags from global data (always a JSON string from template)
        try {
          this.allTags = typeof window.tagsData === 'string' ? JSON.parse(window.tagsData) : (window.tagsData || []);
        } catch (e) {
          console.error('Error parsing tags data:', e);
          this.allTags = [];
        }
        
        // Get initially selected tags (always a JSON string from template)
        let selectedIds = [];
        try {
          selectedIds = typeof window.selectedTagIds === 'string' ? JSON.parse(window.selectedTagIds) : (window.selectedTagIds || []);
        } catch (e) {
          selectedIds = [];
        }
        
        // Filter selected tags
        this.selectedTags = this.allTags.filter(tag => selectedIds.includes(tag.id));
      },
      
      get filteredTags() {
        if (!this.searchQuery) {
          return this.allTags;
        }
        const query = this.searchQuery.toLowerCase();
        return this.allTags.filter(tag => 
          tag.name.toLowerCase().includes(query)
        );
      },
      
      toggleDropdown() {
        this.isOpen = !this.isOpen;
      },
      
      toggleTag(tag) {
        const index = this.selectedTags.findIndex(t => t.id === tag.id);
        if (index > -1) {
          this.selectedTags.splice(index, 1);
        } else {
          this.selectedTags.push(tag);
        }
      },
      
      isSelected(tag) {
        return this.selectedTags.some(t => t.id === tag.id);
      }
    }));
  });
</script>

<style>
  .tag-option:hover {
    background-color: #f8f9fa !important;
  }
  .tag-option.bg-primary:hover {
    background-color: #0b5ed7 !important;
  }
</style>
